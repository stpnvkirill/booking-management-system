groups:
- name: bms_alerts
  interval: 30s
  rules:

  - alert: ServiceDown
    expr: up{job="bms-backend"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Сервис bms-backend недоступен"
      description: "Prometheus не может собрать метрики более 1 минуты"

  - alert: High5xxErrorRate
    expr: |
      (
        sum(rate(http_requests_total{job="bms-backend",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{job="bms-backend"}[5m]))
      ) > 0.05
      and
      sum(rate(http_requests_total{job="bms-backend"}[5m])) > 1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Высокий процент 5XX ошибок"
      description: "Более 5% запросов bms-backend возвращают 5XX"

  - alert: High4xxErrorRate
    expr: |
      (
        sum(rate(http_requests_total{job="bms-backend",status=~"4.."}[5m]))
        /
        sum(rate(http_requests_total{job="bms-backend"}[5m]))
      ) > 0.10
      and
      sum(rate(http_requests_total{job="bms-backend"}[5m])) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Высокий процент 4XX ошибок"
      description: "Более 10% запросов bms-backend возвращают 4XX"

  - alert: SlowAPIResponse
    expr: |
      histogram_quantile(
        0.95,
        sum(rate(http_request_duration_seconds_bucket{job="bms-backend"}[5m]))
        by (le)
      ) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Медленные ответы API"
      description: "p95 latency превышает 1 секунду более 5 минут"

  - alert: TrafficDrop
    expr: sum(rate(http_requests_total{job="bms-backend"}[5m])) < 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Резкое падение трафика"

  - alert: BackendPanic
    expr: increase(panic_total{job="bms-backend"}[5m]) > 0
    for: 0m
    labels:
      severity: critical
